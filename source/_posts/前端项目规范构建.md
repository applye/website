---
abbrlink: 8
title: 前端项目规范构建
categories: 前端
tags:
    - 'husky'
    - 'lint'
    - 'commit'
comments: false
date: 2019-04-15 23:47:20
img: 'https://raw.githubusercontent.com/879733672/images/cdn/img/202304282214836.png'
---

### 前端项目规范构建

规范化提交信息的工具，当我们在多人协作开发过程中，有必要养成良好的 commit 规范，方便日后 review 代码，产出 CHANGELOG 说明等等；
首先，规范的 commit 信息能让人一眼清晰明了的知道该提交属于什么类型、修改范围、具体改动，提高团队协作。也方便我们日后找 bug，提高团队协作. 大家使用较多的[Angular 团队规范](https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#-git-commit-guidelines)。

#### Angluar commit message 规范

该规范将 commit 信息分为 header、body、footer 三个部分。
这三部分中哪一行都不能超过 100 个字符！(angular 规范文档中写的). 因为 git 会将 commit 的主题部分超过 72 个字符的截断显示.

Angluar commit message 格式如下：

```
<type>(<scope>): <subject> // 这一行是Header
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
```

Body 部分比较简单， 为选填项， 指本次提交的具体描述。

header 分为 type、scope、subject 三部分。

(1) type 指本次提交的类型，为必填项，必须为以下之一:

-   feat: 一项新功能
-   fix: 一个错误修复
-   docs: 仅文档更改
-   style: 不影响代码含义的更改（空白，格式，缺少分号等）
-   refactor: 既不修正错误也不增加功能的代码更改（重构）
-   perf: 改进性能的代码更改
-   test: 添加缺失或更正现有测试
-   build: 影响构建系统或外部依赖项的更改（gulp，npm 等）
-   ci: 对 CI 配置文件和脚本的更改
-   chore: 更改构建过程或辅助工具和库，例如文档生成
    (2) scope 指本次提交的影响范围，为可选项，可以是指定提交更改位置的任何内容。我一般都写更改部分的模块名或者文件名. 当更改影响的范围不止一个范围时，可以使用星号(\*)。当然也可以不填写.

(3) subject 指本次提交的简要描述，它有如下两个规则。 不要大写第一个字母; 末尾没有点（.）

Footer 部分 选填 可以包含以下两种情况
(1) 是否产生了破坏性修改
如果当前代码与上一个版本不兼容，如版本升级、接口参数减少、接口删除、迁移等就是破坏性修改。

如果是破坏性修改则 Footer 部分会以 BREAKING CHANGE 开头，后面是对变动的描述、以及变动理由和迁移方法。如下：

```
BREAKING CHANGE: 变动的描述\理由\迁移方法
```

(2) 关闭 Issue 如果当前 commit 针对某个 issue，那么可以在 Footer 部分关闭这个 issue，也可以关闭多个 issue。填写格式如下：

```
Close #ISSUE_ID
Closes #ISSUE_ID, #ISSUE_ID
```

以上是 Angular 团队的 commit 规范，大家也可以根据自己团队的习惯去自定义 commit 规范。

#### 自定义 commit message 规范

自定义的规范是基于 Angluar 规范的，只是在它的基础上加个表情 gitmoji 字段在最打头的位置。格式如下：

```
:gitmoji: <type>(<scope>): <subject> // 这一行是Header
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
```

gitmoji 项是必填的，值只能为 gitmoji 提供的表情列表中的表情。

Angluar 规范里也有写表情的，要借助 git-cz， 它是在 subject 打头显示的表情，跟我想要的效果不符合.

#### 安装 commitizen

1. 安装 commitizen
   commitizen 它会提供 git cz 命令替代我们的 git commit 命令，帮助我们更加方便生成符合规范的 commit message。
   初始化 commitizen 预设，这里使用官网首选的预设 cz-conventional-changelog
   cz-conventional-changelog: 它是 commitizen 的首选适配器，默认有配置，但也可以自定义 types，设置 header 长度之类的属性等。但是它的提示信息都是英文的，不能自定义配置（源码内发现的）。如果需要自定义配置提示信息需要使用 cz-customizable 适配器，文章后面自定义版有这部分内容。

```
npm install --save-dev commitizen cz-customizable
```

在 package.json 加上配置使用 node_modules/cz-customizable 适配器

```
 "config": {
    "commitizen": {
      "path": "node_modules/cz-customizable"
    }
  }
```

cz-customizable 默认会去读取项目中.cz-config.js 配置，所以我们还要新建文件.cz-config.js，官方也提供了一个示例，我们只要复制里面的内容做一下修改处理即可（比如汉化 or 加上 gitmoji 表情）。

如下：

```
'use strict';

module.exports = {
      // 可选类型
  types: [
    { value: ':sparkles:', name: '✨  feat:  新功能' },
    { value: ':bug: fix', name: '🐛  fix:  修复' },
    { value: ':memo: memo', name: '📝  memo:  撰写文档' },
    { value: ':art: style', name: '🎨  代码格式(不影响代码运行的变动)' },
    {
      value: ':hammer: refactor',
      name: '🔨  refactor:  重构(既不是增加feature，也不是修复bug)'
    },
    { value: ':fire: fire', name: '🔥  fire:  移除代码或文件'},
    { value: ':wrench: wrench', name: '🔧  wrench： 修改配置文件' },
    { value: ':zap: zap', name: '⚡️  zap:  性能优化' },
    { value: ':white_check_mark: test', name: '✅  test:  增加测试' },
    { value: ':construction_worker: construction_worker', name: '👷  construction_worker:  构建过程或辅助工具的变动' },
    { value: ':heavy_plus_sign: heavy_plus_sign', name: "➕  heavy_plus_sign:  添加一个依赖项" },
    { value: ':globe_with_meridians: globe_with_meridians', value: '🌐  globe_with_meridians:  国际化与本地化 '},
    { value: ':rewind: rewind', name: '⏪️  rewind:   回退' },
    { value: ':package: package', name: '📦️  package:    打包' }
  ],
  // 消息步骤
  messages: {
    type: '请选择提交类型:',
    customScope: '请输入修改范围(可选):',
    subject: '请简要描述提交(必填):',
    body: '请输入详细描述(可选):',
    footer: '请输入要关闭的issue(可选):',
    confirmCommit: '确认使用以上信息提交？(y/n/e/h)'
  },
  // 跳过问题
  skipQuestions: ['body', 'footer'],
  // subject文字长度默认是72
  subjectLimit: 72
};
```

我们看下效果:

```
git add .             // 需要add先
npx git cz            // 注意：使用npx命令
```

![](https://raw.githubusercontent.com/879733672/images/cdn/img/202210181127562.png)
正常 git 流程应该是 git add . > git commit -m 'xx', 这里我们用 npx git cz 取代 git commit 操作

#### 提交校验

1. Install husky

husky 是一个 Git hooks 工具,内置了许多钩子处理命令，我们在 git commit 的时候需要校验 commit 信息，这时候 husky 就派上用场了。

```
npm install husky --save-dev
```

2. 启用钩子

```
npx husky install
```

完成后项目根目录下应该会有一个.husky 文件夹。

3. 安装 commitlint

    ```
    npm install --save-dev @commitlint/{config-conventional,cli}
    ```

    - 配置 commitlint
      项目根目录创建 commitlint.config.js。可自行配置规则. 配置声明继承 cz

    ```
    module.exports = {
        extends: ['cz'],
        rules: {
            'type-empty': [2, 'never'],
            'subject-empty': [2, 'never']
        }
    };
    ```

    - 编辑 package.json 文件。

    ```
    {
    "scripts": {
        "prepare": "husky install"
    },
    "husky": {
        "hooks": {
        "commit-msg": "commitlint -E $HUSKY_GIT_PARAMS",
        "pre-commit": "lint-staged" // 下一篇会有说，可在commit前执行自定义命令
        }
    }
    }
    ```

    prepare 该配置可以将下载其他依赖完成时自动启用 git 钩子

    - 添加 husky
      // 在项目根目录执行

    ```
    npx husky add .husky/commit-msg 'npx --no -- commitlint --edit $1';
    ```

    - 运行结果：
      发现是 commitlint 不支持 emoji 表情，那我们把上面的.cz-config.js 里的 emoji 表情去掉就可以了。

    那我们想要支持 emoji 表情校验怎么办？请看第三步：

    - 支持 emoji 表情校验
      如果 commit 信息没有表情，可以跳过此步骤

    ```
    npm i -D commitlint-config-gitmoji @commitlint/core
    ```

    - 配置文件修改

    配置 commitlint.config.js。可自行配置规则. 配置声明继承 cz

    ```
    module.exports = {
        extends: ['gitmoji', 'cz'],  // 配置表情需要依赖
        rules: {
            'type-empty': [2, 'never'],
            'subject-empty': [2, 'never']
        }
    };
    ```

    - 运行 npm run commit // package.json scripts 配置： "commit": "git-cz" 显示配置的提交信息
      ![](https://raw.githubusercontent.com/879733672/images/cdn/img/202210181437621.png)

    - 生成日志 conventional-changelog, 默认不带图标标题，可以正常生成，如果带了图标需要添加适配，才能正常生成。
      package.json 配置如下：

    ```
    npm i -D conventional-changelog-cli conventional-changelog-gitmoji-config
    ```

    ```
       "scripts": {
            "changelog": "conventional-changelog -p gitmoji-config -i CHANGELOG.md -s -r 0",
        },
    ```

    // "changelog": "conventional-changelog -p gitmoji-config -i CHANGELOG.md -s -r 0", 每次重新生成日志

    // "changelog": "conventional-changelog -p gitmoji-config -i CHANGELOG.md -s, 每次追加日志

    - 运行 npm run changelog 生成日志。

    - standard-version 使用
      当我们要发布版本的时候，通常的做法是，更新 package.json 里的版本号，更新 CHANGELOG，描述了更新了什么操作，然后 git add -> git commit,打上 tag 标签，有了 standard-version,可以帮我们自动跑上面操作。

    ```
    npm i --save-dev standard-version
    ```

    npx 命令写入 package.json script 中方便调用

    ```
     "scripts": {
        "release": "standard-version"
    },
    ```

    - 为 standard-version 增加--perset 配置, 配置带表情的

    ```
    "scripts": {
        "release": "standard-version --preset gitmoji-config",
    }
    ```

    - 添加 package.json

    ```
    "commit": "git-cz",
    "release": "standard-version --preset gitmoji-config",   // 在此基础上升级版本，并写入日志，打包tag
    "push:publish": "npm run build && git push --follow-tags origin master && npm publish",
    ```

    - 运行如下：
      ![](https://raw.githubusercontent.com/879733672/images/cdn/img/202210181512828.png)

    - 当执行 git push 的时候，就会自动生成 CHANGELOG.md 一并提交到远端了，就不用手动执行 npm run release 命令再 push 了。
      直接在 pre-push 钩子里执行生成 CHANGELOG 的命令。
      npx husky add .husky/pre-push 'npm run release';
      .husky/pre-push

    ```
    #!/bin/sh

    npm run release
    ```

4. lint-staged prettier

    - 安装 lint-staged prettier

    ```
    npm install lint-staged prettier --save-dev
    ```

    - 配置 package.json

    ```
    "scripts": {
        // 新增
        "lint-staged": "lint-staged",
    },
    "lint-staged": {
        "*.{js,ts,vue,jsx,tsx}": [   // 代码格式化，eslint 检查
        "prettier --write",
        "eslint --cache --fix",
        "git add"
        ]
    },
    ```

    - 添加 husky

    ```
    npx husky add .husky/pre-commit 'npm run lint-staged'
    ```
    配置完成
    --no-verify 可以配置本次提交跳过检查
    ```
    git commit -m '提交信息' --no-verify
    ```

5. jest 测试添加
    ```
    npm install jest ts-jest @types/jest --save-dev
    ```
    jest.config.js
    ```
    module.exports = {
        preset: "ts-jest",
        testEnvironment: "node",
    };
    ```
    package.json
    ```
    "test": "jest",
    ```
  
6. eslint配置
    ```
    npm install eslint typescript-eslint/parser typescript-eslint/eslint-plugin --save-dev
    ```
   修改.eslintrc.js
   ```
   module.exports = {
        "env": {
        es2021: true,
        amd: true, // 否则会出现'require' is not defined 提示
        es6: true,
        browser: true,
        jquery: true,
        node: true,
        },
        "extends": [
        "eslint:recommended",
        "plugin:@typescript-eslint/recommended"
        ],
        "overrides": [],
        "parser": "@typescript-eslint/parser",
        "parserOptions": {
        "ecmaVersion": "latest",
        "sourceType": "module"
        },
        "plugins": [
        "@typescript-eslint"
        ],
        "rules": {
        "@typescript-eslint/no-unused-vars": [
        "error",
        {
        "varsIgnorePattern": "^_"
        }
        ],
        "@typescript-eslint/no-inferrable-types": "off",
        "no-unused-vars": "off",
        "no-console": "warn",
        "semi": "warn",
        //关闭“禁用 console”规则
        //缩进不规范警告，要求缩进为 2 个空格，默认值为 4 个空格
        indent: [
        'warn',
        4,
        {
        //设置为 1 时强制 switch 语句中 case 的缩进为 2 个空格
        SwitchCase: 1,
        },
        ],
        // 函数定义时括号前面要不要有空格
        'space-before-function-paren': [0, 'always'],
        //定义字符串不规范错误，要求字符串使用双引号
        // quotes: ["error", "double"],
        //....
        //更多规则可查看http://eslint.cn/docs/rules/
        }
   }

    ```
    package.json
    ```
    "lint": "eslint --ext .vue,.js,.jsx,.ts,.tsx ./src",
    "lint:fix": "eslint --ext .vue,.js,.jsx,.ts,.tsx --fix ./src"
    ```
